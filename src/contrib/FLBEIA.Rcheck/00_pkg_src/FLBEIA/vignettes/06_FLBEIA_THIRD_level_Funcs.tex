
\subsection{Third level functions}

%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
\subsubsection{Population growth functions}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  The following population growth functions are currently defined:
%----------------------------------------------------------------------------------------------------	

\paragraph{\texttt{fixedPopulation}: Fixed population function} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------
		
	In this function all the parameters are given as input, 
  because there is not any population dynamics simulated.
  For the stocks for which we select its dynamics as fixed population, 
  natural mortality (i.e. \texttt{biols[[stock.name]]@m}) has to be set equal to 0 
  and additionally, if the population is aggregated in biomass, biomass growth (i.e. \texttt{BDs[[stock.name]]@gB}) 
  has also to be set equal to 0.


\paragraph{\texttt{ASPG}: Age Structured Population Growth function} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------
		
	The function \texttt{ASPG} describes the evolution of an age structured population using an 
	exponential survival equation for existing age classes and a stock-recruitment 
	relationship to generate the recruitment. The recruitment can occur in one or more seasons.	
	However, the age is measured in integer years and the seasonal cohorts are tracked 
	separately. The seasonal cohorts and their corresponding parameters are stored in 
	the '\texttt{unit (u)}' dimension of the \texttt{FLQuant}-s. And all the individuals 
	move from one age group	to the following one in the 1st of January.  Thus, being
	$\phi$ the recruitment function, $RI$ the reproductive index, 
	$N$ the number of individuals, $M$ the natural mortality,  
	$C$ the catch, $a_0$ the age at recruitment, $s_0$ the season when the recruitment
	was spawn, and $a$, $y$, $u$, $s$ the subscripts for age, year, unit  
	and season respectively, the population dynamics can be written mathematically as:
			
	If $s = 1$,
		
			\begin{equation}
				N_{a,y,u,1} = \left\{ 
				\begin{array}{l l}
	 				\phi\left( RI_{y = y-a_0, s = s - s_0}	\right) 					& \text{, } a = a_0\\ % RECRUITMENT
	 				(N_{i_a}\cdot e^{-\frac{M_{i_a}}{2}} - C_{i_a}) % MIDDLE AGES
	 				\cdot e^{-\frac{M_{i_a}}{2}}	& \text{, } a_0 < a < A\\ 
	 				% PLUSGROUP	
	 				(N_{i_{A-1}}\cdot e^{-\frac{M_{i_{A-1}}}{2}} - C_{i_{A-1}})\cdot e^{-\frac{M_{i_{A-1}}}{2}} + \\
	 				(N_{i_A}\cdot e^{-\frac{M_{i_A}}{2}} - C_{i_A})\cdot e^{-\frac{M_{i_A}}{2}}  & \text{, } a = A\\
	 				\end{array} \right.
		  \end{equation}
		
	\noindent where $i_a = (a-1,y-1,u,ns)$, $i_{A-1} = (A-1,y-1,u,ns)$ and  $i_A = (A,y-1,u,ns)$.
    
  If $s > 1$,
		
		\begin{equation}
			N_{a,y,u,s} = \left\{ 
				\begin{array}{l l}
	 			\phi\left( RI_{y = y-a_0, s = s - s_0}	\right) 					& \text{, } a = a_0\\ % RECRUITMENT
	 			% AGES > REC
	 			(N_{i_a}\cdot e^{-\frac{M_{i_a}}{2}} - C_{i_a}) \cdot e^{-\frac{M_{i_a}}{2}}	& \text{, } a_0 < a \leq A\\
	 		\end{array} \right.
		\end{equation}
		
	\noindent where $i_a = (a, y, u, s-1)$.
    
  And the reproductive index $RI$ is  given by:

		\begin{equation}
		 	RI_{y-a_0,s} = 	\sum_a \sum_u (N \cdot wt \cdot mat \cdot fec 
		 	                \cdot exp-(M \cdot M_{spwn}+F \cdot F_{spwn}))_{a,y-a_0,u,s}
		\end{equation}
		
	\noindent where $wt$ is the mean weight, $mat$ is the percentage of mature individuals, 
	                $fec$ is the fecundity parameter, 
	                $M_{spwn}$ and $F_{spwn}$ are the proportion of natural and fishing mortality, respectively, 
	                occurring before spawning.

	The stock-recruitment relationship $\phi$ is specified in the \texttt{model} slot of corresponding 
	\texttt{FLSRsim} object. \texttt{FLSRsim} object enables modeling a great variety of stock-recruitment relationships depending 
	on its functional form and seasonal dynamics. Details on available stock-recruitment relationships are given in Section~\ref{sec:SRR}.
	
	
\paragraph{{\texttt{BDPG}: Biomass Dynamics Population Growth function}} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

	The function \texttt{BDPG} describes the evolution of a biomass dynamics population, i.e. a population with no 
  age, stage or length structure. The population is aggregated in biomass, $B$, and the growth of the population, $g$
  is a function of the current biomass and the catch $C$. The model is mathematically described in Equation~\ref{eq:BDPG}: 
	
	\begin{equation}
		B_{s,y} = \left\{ 
				\begin{array}{l l}
	 					B_{s-1,y}  + g(B_{s-1,y}) - C_{s-1,y}  & \text{, } s \neq 1\\
	 					B_{ns,y-1} + g(B_{ns,y-1}) - C_{ns,y-1}& \text{, } s = 1
  			\end{array} \right.
  	\label{eq:BDPG}
	\end{equation}
  
  \noindent where $s$ and $y$ are the subscripts for age and year, respectively, and $ns$ is the number of seasons.
	As \texttt{FLBEIA} is seasonal, the equation also depends on the season. The growth model $g$ and its parameters are 
	specified, respectively, in the \texttt{model} and \texttt{params} slot of corresponding \texttt{FLBDsim} class.  
	Currently only Pella and Tomlinson model \citep{Pella1969} is	implemented to model growth, but new models can be defined if needed.
	
	The following parameterization of the growth model has been implemented:
	
	\begin{equation}
		g(B) = B\cdot \frac{r}{p}\cdot\left[1-\left(\frac{B}{K}\right)^p\right]
	\end{equation}
  
  \noindent where $r$ is the intrinsic rate of population increase, $K$ the carrying capacity and $p$ the assymetry parameter.
  Additionally, there has been added a restriction in order to avoid negative values.
  This arises when population is at high biomass values (well above carrying capacity) 
  and outside the range of observed biomass levels in the past. 
  Moreover, it doesn't occur for larger catches that result in lower biomass levels. 
  Intuitively, this seemed to be contradictory because the population collapsed in the absence of catches case 
  and remained stable for higher catch levels. 
  Therefore, in the absence of catches, we restrict the biomass to be $\alpha$ times the carrying capacity 
  ($B_t \leq \alpha \cdot K$). 
  In other words, $B_t = min(B_t, \alpha \cdot K)$. But note that:
   $$ \alpha \geq 1 $$
   $$ \alpha \leq \left(\frac{p}{r}+1\right)^{\frac{1}{p}}$$
	Note that when we introduce stochasticity in the parameters of the Pella-Tomlinson model 
	(e.g. from a Bayesian model or from a bootstrapping) we have a range of values for the surplus production model. 
	So that $\alpha$ must be smaller than the minimum value across iterations: $\alpha \leq min_i((p_i/r_i+1)^{1/p_i})$.
  The value of $\alpha$ has to be introduced by the user in the \texttt{BDs[[stock.name]]@alpha}.
  Above restrictions will be checked in \texttt{FLBEIA} and it will print an error if they are not fullfilled.
  Finally, note that these restrictions arise from the no catch case. 
  So, even after restricting the biomass, there might be cases when some levels of catches lead to negative biomasses. 

  When working with populations structured in biomass, the biomass values has to be stored in the \texttt{*.n} slots, whereas \texttt{*.wt} slots has to be set to 1.

%----------------------------------------------------------------------------------------------------
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\subsubsection{Effort models}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	

  The following effort model functions are currently defined:

\paragraph{\texttt{fixedEffort}: Fixed effort model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

	  In this function all the parameters are given as input except discards and landings 
	(total and at age). The only task of this function is to update the discards and landings (total and at age)
	according to the catch production function specified in \texttt{fleets.ctrl} argument.
		
	Two arguments need to be declared as elements of \texttt{fleets.ctrl} if this function is used, \texttt{effort.model = 'fixedEffort'} 
	and \texttt{catch.model}. The last argument is used to specify the catch production function that will be used to generate the catch. 
  Note that first argument must be declared at fleet level (i.e \texttt{fleets.ctrl[[fleet.name]]\$effort.model}), 
  second argument at fleet and stock level (i.e. \texttt{fleets.ctrl[[fleet.name]][[stock.name]]\$catch.model})
	and that catch production model corresponds with a fourth level function. For more details see Section~\ref{sec:CprodFun}.
		
		
\paragraph{\texttt{SMFB}: Simple Mixed Fisheries Behaviour model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

		This model is a simplified version of the behavior of fleets that work in a 
	mixed fisheries framework. The function is seasonal and assumes that effort share among metiers is
	given as input parameter.
	 
	In each season, the effort of each fleet, $f$, is restricted by the seasonal landing quotas or catch quotas
	of the stocks that are caught by the fleet. Additionaly, the option of Landing Obligation (LO) is included. 
	The following steps are followed in the calculation of effort:
	

\begin{enumerate}
	
	\item Compare the overall seasonal quotas, $\sum_f Q_{f,s,st}\cdot TAC$, with the abundances of the stocks.
		 If the ratio between overall quota and abundance exceeds the 
		seasonal catch threshold, $\gamma_{s,st}$, reduce the quota share in the same degree. Mathematically: 
		
	\begin{equation}
		Q'_{f,s,st} = 
			\begin{cases}
			 		Q_{f,s,st}	     & \text{, if }  \frac{\sum_f Q_{f,s,st}\cdot TAC}{B_{s,st}} \leq \gamma_{s,st}\\
   					Q_{f,s,st}\cdot \frac{B_{s,st}\cdot \gamma_{s,st}}{\sum_f Q_{f,s,st}\cdot TAC}   & \text{, otherwise} 
			\end{cases} 
	\end{equation}
		
  \item According to the catch production function, calculate the efforts corresponding to the landing or 
		catch quotas, $Q'_{f,s,st}\cdot TAC$, of the  
		individual stocks, $\left\{ E_{f,s,st_1},\ldots, E_{f,s,st_n} \right\}$.
	
	\item Based on the efforts calculated in the previous step, calculate an unique effort, $E_{f,s}$. 
		To calculate this effort the following options can be used:
		\begin{description}  
			\item[\texttt{max}:] The maximum among possible efforts, $\hat{E}_{f,s} = \max_{j=1,\ldots,n} E_{f,s,st_j}$
			\item[\texttt{min}:] The minimum among possible efforts, $\hat{E}_{f,s} = \min_{j=1,\ldots,n} E_{f,s,st_j}$
			\item[\texttt{mean}:] The mean of possible efforts, $\hat{E}_{f,s} =  \mean_{j=1,\ldots,n} E_{f,s,st_j}$
			\item[\texttt{previous}:] The effort selected is the effort most similar to previous year effort on 
				that season, 
				$$\hat{E}_{f,s} = \left\{ E_{f,s,st} :   
				\left|1 - \frac{E_{f,s,st}}{E_{f,y-1,s}}\right| = \min_{j=1,\ldots,n} \left|1 - \frac{E_{f,s,st_j}}{E_{f,y-1,s}}\right|\right\}$$
  	 	\item[\texttt{stock.name}:] The effort corresponding to \texttt{stock.name} is selected:
				$\hat{E}_{f,s} =  E_{f,s,\texttt{stock.name}}$
		\end{description}
		If  there is LO, instead of using the option chosen by the user, the option to calculate the unique effort 
		will be the minimum among possible efforts.
	
	\item When LO is applied, calculate the new effort using the exemptions and flexibilities (de Minimis, 
	  year tranfer and quota swap). 
	  \begin{itemize}
  		\item \textit{de Minimis}: The fleet is allowed to discard a percentage of the quota to increase the effort 
  		  in order to catch other stocks.
  		\item \textit{year transfer}: The fleet can borrow next year's quota to catch it in the current year.
  		\item \textit{quota swap}: A percentage of the quota of one stock can be transfered to the effort 
  		  limiting stock if two stocks are in the same group. These groups are specifiyed by the user.
	  \end{itemize}		
		
  \item Compare the effort, $\hat{E}_{f,s}$, with the capacity of the fleet, $\kappa_f$  
    (capacity must be measured in the same units as effort and it must be stored in the \texttt{capacity} slot 
    of the \texttt{FLFLeetsExt} object). 
		If the capacity is bigger, then the final effort is unchanged and if the capacity is smaller, 
		the effort is set equal to the capacity, i.e.:
	
	\begin{equation}	
			E_{f,s} =
  				\begin{cases}
  				 	\kappa_f			 & \text{, if } \kappa < \hat{E}_{f,s}\\
   					\hat{E}_{f,s}  & \text{, if } \kappa \geq \hat{E}_{f,s}
  				\end{cases}
	\end{equation}	 
	
	\item The catch corresponding to the effort selected is calculated for each stock and compared with the 
	  corresponding quota. 
		If the catch is not equal to the quota and the season is not the last one, 
		the seasonal quota shares of the rest of the seasons are reduced or increased 
		proportionally to their weight in the total share. The shares are changed 
		in such a way that the resultant annual quota share is equal to the original one.
		In case the difference between actual catch and that corresponding to the quota exceeds
		the quota left over in the rest of the seasons, the quota in the rest of the seasons is
		canceled.	Mathematically for season $i$ where $s \leq i \leq ns'$: 
		
	\begin{equation}
		Q''_{f,i,st} =  \max\left( 0,Q'_{f,i,st} + (Q'_{f,s,st} - Q''_{f,s,st}) \cdot 
		                \frac{Q'_{f,i,st}}{\sum_{j>s} Q'_{f,j,st}}\right) 
	\end{equation}
		
		\noindent where $Q'$ denotes the quota share obtained in the first step and $Q''$ the new quota share. 
	
\end{enumerate}

\subparagraph{The \texttt{fleets.ctrl} argument in \texttt{SMFB} function}
\quad\\	

	\texttt{SMFB} function requires several control arguments at global and fleet level that are described below.

  \quad\\
		Global arguments:
		\begin{description}
		
			\item[\texttt{catch.threshold}:] This element is used to store $\gamma_{s,st}$ parameter described in
				the first step of \texttt{SMFB} function algorithm. The element must be a \texttt{FLQuant} object with dimension 
		        \texttt{[stock = nstk, year = ny, unit = 1, season = ns, area = 1, iter = ni]}, where the
	            names in the first dimension must match with those used to name \texttt{FLBiols} object. 
	            Thus, the thresholds may vary between stocks, seasons, years and iterations.
	    		The elements of the object are proportions between 0 and 1 that indicate the maximum percentage of the 
	    		stock that can be caught in each season. The reason to use this argument is that it is reasonable to think
	    		that it is impossible to fish all the fish in the sea. Thus, although the TAC is very large the actual catch
	    		will be restricted to  $\gamma_{s,st}\cdot B_{s,st}$.
			
			\item[\texttt{seasonal.share}:]  A named \texttt{FLQuants} object, one per stock, with the proportion of the 
				fleets' TAC share that 'belongs' to each season, so the sum along seasons for each fleet, year and iteration
				should be equal to 1.	The elements must be \texttt{FLQuant} objects with dimension 
		        \texttt{[fleet = nf, year = ny, unit = 1, season = ns, area = 1, iter = ni]}, where the
	            names in the first dimension must match with those used to name \texttt{FLFleetsExt} object. 
	            The names of the \texttt{FLQuants} must match stock names used in the \texttt{FLBiols} object. 
		\end{description}
		
	\quad\\			
		Fleet level arguments (i.e. \texttt{fleets.ctrl[[fleet.name]]}):
    		
		\begin{description}
			\item[\texttt{effort.model}:] \texttt{'SMFB'}.
			\item[\texttt{effort.restr}:] alternative values are \texttt{'max'}, \texttt{'min'}, \texttt{'mean'}, 
			  \texttt{'previous'} or \texttt{'stock.name'} (the name of one of the stocks caught by the fleet). 
				\begin{description}
					\item[\texttt{max}:] The fleet will continue fishing until the catch quotas of all the stocks are exhausted. 
					\item[\texttt{min}:] The fleet will stop fishing when the catch quota of any of the stocks is exhausted. 
					\item[\texttt{previous}:] Among the efforts obtained under each stock restriction the effort most similar 
					  to the previous year effort will be selected. 
					\item[\texttt{stock}:] The fleet will continue fishing until the catch quota of '\texttt{stock}' is exhausted. 
					  (This could correspond, for example, with a situation where the catch of one stock is highly controlled.)								\end{description}
				These options are explained mathematically above when the \texttt{SMFB} function is described step by step. 
			  There are two alternatives: one option for all years or one option for each year (vector with the length ny).
			\item[\texttt{restriction}:] Alternative values are \texttt{'catch'} or \texttt{'landings'}. 
			  Assigned value depends on wether the efforts are calculated according to catch or landings restriction. 
			  There are two alternatives: one option for all years or one option for each year (vector with the length ny).
      \item[\texttt{LandObl}:] Logical or vector with a logic value for each year. 
        If it is \texttt{TRUE} for that year, LO rule is applied. 
        The fleet has to stop fishing when they reach the first quota of the stocks. 
        Therefore, the unique effort will be the minimum among possible efforts. 
			\item[\texttt{LandObl\_minimis}:] Vector with a logic value for each year. 
			  If it is \texttt{TRUE} for that year, \textit{de Minimis} exemption is used.
			\item[\texttt{LandObl\_yearTransfer}:] Vector with a logic value for each year. 
			  If it is \texttt{TRUE} for that year, \textit{year Transfer} flexibility is used.
			\item[\texttt{LandObl\_minimis\_p}:] Matrix with values between 0 and 1, the maximum percentage of quota that 
			  the fleet could increase for each stock in each year. 
			\item[\texttt{LandObl\_yearTransfer\_p}:] Matrix with values between 0 and 1, the maximum percentage of quota 
			  of each stock that the fleet could borrow from next year's quota. 
			\item[\texttt{LandObl\_discount\_yrTranfer}:] Matrix with values between 0 and 1. 
			  The discount to be applied if in the previous year was used that amount. 
			  This object is used to store the percentage used from the next year's quota.
			\item[\texttt{LO\_stk\_grp}:] named vector with length equal to the number of stocks, 
			  same number for the same group of stocks to swap the quotas.
    \end{description}
    
  \quad\\
		Fleet/stock level arguments (i.e. \texttt{fleets.ctrl[[fleet.name]][[stock.name]]}):
	
    \begin{description}
  		\item[\texttt{catch.model}:] The name of the fourth level function which gives the catch production 
  				given effort and biomass (aggregated or at age). The function must be coherent with \texttt{SMFB}
  				and the function used to simulate the population growth. 
  				At the moment, two functions are available	\texttt{CobbDouglasAge} and \texttt{CobbDouglasBio}.
  				For more details see Section~\ref{sec:CprodFun}.
    \end{description}


\paragraph{\texttt{SSFB}: Simple Sequential Fisheries Behaviour model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  Simple sequential fisheries behaviour is related to those fleets whose fishing profile changes with 
  the season of the year. \texttt{SSFB} function models the behaviour of fleets that work in a sequential 
  fisheries framework. It is assumded that, in each season, the fleet, $f$, has only one target species or 
  stock, $st$, thus the metier, $m$, is defined on the basis of the   season and target species, resulting 
  only in one target species per each metier.
  
  In each season, $s$, the effort allocated to each species, $st$, or metier, $m$, follows the historical trend (in order to capture the 
  seasonality of each species fishing season), but it is restricted to the remaining catch quota of the fleet. 
  
  Therefore, production function is applied at metier level, but the production has some restrictions, 
  in both catches, $C$, and effort, $E$, that are described through the following steps: 
  
  \begin{enumerate}
    
    \item Calculate the total quota that corresponds to each fleet, $CQ$, from the historical data and estimate remaining
    quota for the fleet, $RQ_{s,f,st}$, deducting the catches from previous seasons.
  					$$RQ_{s,f,st} = CQ_{f,st} - \sum_{ss<s} {C_{ss,f,st}} = TAC \cdot QS_{f,st} - \sum_{ss<s} {C_{ss,f,st}}$$
    \noindent Where $QS$ is the quota share and $C$ the catches.
    
    \item Compare the total remaining quotas with the abundances of the stocks. If the ratio between remaining quotas and
    abundance exceeds the seasonal catch thershold, $\gamma_{s,st}$, then reduce the remaining quota the same amount.
    		\[
     			RQ'_{s,f,st} = \begin{cases}
       							RQ_{s,f,st} & \text{, if } \frac {\sum_f Q_{s,f,st}}{B{s,st}} \leq \gamma_{s,st}; \\
       							RQ_{s,f,st} \cdot  \frac{B{st,s} \cdot \gamma_{s,st}} {\sum_{f} RQ_{s,f,st}} & \text{, otherwise.} 
                     \end{cases}
    		\]
		
    \item Initially expected effort, $\hat E_{s,f}$, is shared between different metiers (i.e. species) month by month
    on the basis of historical seasonal effort pattern.
    				$$\hat E_{s,m,st} = \hat E_{s,f} \cdot E_{s,m} = \kappa_f \cdot PED_{s,f} \cdot  E_{s,m}$$
    \noindent Where $E_{s,m}$ is the effort share by metier, $PED_{s,f}$ is the percentage of effective days and $\kappa_f$ is the 
    fleet's capacity.

    \item Expected catches ,$\hat C_{s,m,st}$, corresponding to that initial effort, are calculated through the Cobb-Douglas catch
    production function at metier and stock level, seasonally.
    
    \item If the expected catches resulting from the previous step are higher than the remaining quota corresponding to
    each metier (Step 2), there is extra effort which has to be reallocated among the other species.
        $$\text{If   } \hat C_{s,f,st} > RQ_{s,f,st} \Rightarrow 
                        \hat C_{s,f,st} = RQ_{s,f,st} \Rightarrow E_{s,m,st} < \hat E_{s,m,st}; $$
       	$$\text{else } \hat C_{s,f,st} \leq RQ_{s,f,st} \Rightarrow
                        \hat C_{s,f,st} = C_{s,f,st} \Rightarrow E_{s,m,st} = \hat E_{s,m,st}.$$

    \item The reallocation of remaining effort, $\hat E_{s,m,st} - E_{s,m,st}$, can be performed in different ways:
      \begin{itemize}
        \item Proportionally to the price and availability of the species in a given season, or
        \item proportionally to the effort allocated to the remaining metiers.
      \end{itemize}
    
    \item This is repeated stock by stock until no effort remains to be allocated or all the TACs are exhausted

  \end{enumerate}
  
\subparagraph{The \texttt{advice} argument in \texttt{SSFB} function}
\quad\\

  \texttt{SSFB} function requires arguments in the \texttt{advice} object as described below.

  \quad\\
  \noindent Global arguments:
  \begin{description}
  	\item \texttt{quota.share}: A named \texttt{FLQuants} object, one per stock, with the total proportion of TAC that 'belongs' to 
  		each fleet each year and dimension \texttt{[fleet = nf, year = ny, unit = 1, season = 1, area = 1, iter = ni]}. The '\texttt{fleet}' dimension names must match fleets' names. And the \texttt{FLQuants} must match stock names. 
  		For each year and iteration the sum of the proportions must be equal to 1. 
  \end{description}

\subparagraph{The \texttt{fleets.ctrl} argument in \texttt{SMFB} function}
\quad\\

  \texttt{SSFB} function requires several control arguments at global and fleet level that are described below.

  \quad\\
  \noindent Global arguments:
  \begin{description}
    \item[\texttt{catch.threshold}:] A \texttt{FLQuant} object with dimension \texttt{[stock = nst, year = ny, unit = 1, season = ns, area = 1, iter = ni]}, which contains the proportion of biomass that total catch of stock cannot exceed, i.e. the previously mentioned $\gamma_{s,st}$ parameter.
  \end{description}

  \quad\\
  \noindent Fleet level arguments (i.e. \texttt{fleets.ctrl[[fleet.name]]}):
  \begin{description}
  	\item[\texttt{effort.model}:] '\texttt{SSFB}'
  	\item[\texttt{restriction}:] '\texttt{catch}'. Related to quota threshold.
    \item[\texttt{effectiveDay.perc}:] A  \texttt{FLQuant} object with dimension \texttt{[quant = 1, year = ny, unit = 1, season = ns, area = 1, iter = ni]}, which contains the proportion of days expected to be effective in a season (i.e. in which the fleet will go out fishing), the previously mentioned $PED$ parameter (see Step 3).
  	\item[\texttt{effort.realloc}:] Alternative values are \texttt{NULL} or '\texttt{curr.eff}'. Element used to describe how does the remaining effort have to be reallocated between the rest of the metiers targeting stocks for which there is already remaining quota.
  		\begin{description}
  			\item[\texttt{NULL}:] The same proportion is assigned for all metiers.
  			\item[\texttt{curr.eff}:] Effort is reallocated proportionally to the expected effort share. 
  		\end{description}
  \end{description}
  
  \quad\\
  \noindent Fleet/stock level arguments (i.e. \texttt{fleets.ctrl[[fleet.name]][[stock.name]]}):
  \begin{description}
    \item[\texttt{TAC.OS.model}:] Function to model the TAC overshoot. 
      Currently the only available function is \texttt{TAC.OS.triangCond}, which simulates a triangular distribution function 
      for TAC overshoot, in the range \texttt{(min, max)} and a peak in the \texttt{mode}.
    \item[\texttt{TAC.OS.triangCond.params}:] A named numeric vector of dimension 3. 
      Corresponding to the parameters required by \texttt{TAC.OS.triangCond} function, \texttt{min}, \texttt{max} and \texttt{mode}.
    \item[\texttt{discard.TAC.OS}:] Logical. If \texttt{TRUE}, the TAC overshoot is discarded, in other case the TAC overshoot
      is incorporated to landings.
  \end{description}


\paragraph{\texttt{MaxProfit}: Maximization of profit under a TAC constraint model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

This second model used to simulate \textit{mixed fisheries} dynamics calculates the total effort and the effort 
  allocation among metiers that maximises the profit of the fleet.
  The total effort is constrained by the capacity of the fleet (capacity unit has to be converted in the same unit as effort) 
  and by the catch quota of some  of the stocks. Mathematically:
                                               
    \begin{equation}\label{eq:maxprof.stkCnst}
                   \max_{E_f, \gamma_{f,1},\ldots,\gamma_{f,n_{MT,f}}} 
                    \sum_m\sum_{st}\sum_a  L_{st,a,f,m} \cdot P_{st,a,f,m}- 
                           E_f\cdot\gamma_{f,m}\cdot VaC_{f,m} - FxC_f\cdot n_{V_f}                                                   
    \end{equation}

  \noindent with the constraints:

  \begin{equation}\label{eq:MP_consts}
                  \left\{
                  \begin{array}{ll}
                                 & 0 \leq \gamma_{f,m}\leq 1 \text{ and } \sum_m\gamma_{f,m} = 1\\
                                 & E_f \leq \kappa_f,\\
                                 & C_{st,f} \leq QS_{st,f} \quad \text{for } st \in \Delta_f.
  %                            & C_{st} \leq \tau \cdot B_{st} \text{for any $st$}
                  \end{array}        
                  \right.
  \end{equation}

\noindent where $P$ is the price of the fish landed, 
  $VaC$ the variable cost of fishing effort, which depends on the metier and is given as cost per unit of effort, 
  $FxC$ the fixed costs of each fishing unit, which is given at fleet level and in terms of cost per vessel,
  $n_{V}$ is the number of vessels in the fleet,
  $\kappa$ is the capacity, defined as the maximum effort that the fleet can execute in each season,
  $QS$ is fleet's TAC share and
  $\Delta$ is the set of stocks for which the constraint must be fulfilled. 
In biomass dynamic populations, landings and prices are given at stock level.

\subparagraph{The \texttt{fleets.ctrl} argument in \texttt{MaxProfit} function}
\quad\\

  \texttt{MaxProfit} function requires several control arguments at fleet level
    that are described below.

  \quad\\
  \noindent Fleet level arguments (i.e. \texttt{fleets.ctrl[[fleet.name]]}):
  \begin{description}
    \item[\texttt{stk.cnst}:] A vector with the name of the stocks that constraints the capacity 
       of the fleet (i.e. maximum effort that fleet can execute in each season) 
       given the catch quota of these stocks.  
    
  \end{description}

  \quad\\
  \noindent Fleet/stock level arguments (i.e. \texttt{fleets.ctrl[[fleet.name]][[stock.name]]}):
  \begin{description}
    \item[\texttt{TAC.OS.model}:] Function to model the TAC overshoot. 
      Currently the only available function is \texttt{TAC.OS.triangCond}, which simulates a triangular distribution function 
      for TAC overshoot, in the range \texttt{(min, max)} and a peak in the \texttt{mode}.
    \item[\texttt{TAC.OS.triangCond.params}:] A named numeric vector of dimension 3. Corresponding to the parameters required by \texttt{TAC.OS.triangCond} function, \texttt{min}, \texttt{max} and \texttt{mode}.
    \item[\texttt{discard.TAC.OS}:] Logical. If \texttt{TRUE}, the TAC overshoot is discarded, in other case the TAC overshoot
      is incorporated to landings.
  \end{description}


\paragraph{\texttt{MaxProfitSeq}: Maximization of profit under a TAC constraint model for a sequential fishery} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

\texttt{MaxProfitSeq} is similar to the function MaxProfit, but with an additional constraint on the effort.
As the effort of each metier is limited by a minimum and maximum effort value. That is:

  \begin{equation}\label{eq:MPSeq_consts}
      E_{min_{f,m}} \leq  E_f \cdot \gamma_{f,m} \leq E_{max_{f,m}}
  \end{equation}

\noindent where $E$ is the effort, $\gamma$ the effort share by metier and 
  $E_{max}$ and $E_{min}$ are the maximum and minimum efforts, respectively.

\subparagraph{The \texttt{fleets.ctrl} argument in \texttt{MaxProfitSeq} function}
\quad\\

  Additionally to the control elements required by texttt{MaxProfitSeq} function, 
  texttt{MaxProfitSeq} function requires the following arguments at fleet level:

  \quad\\
  \noindent Fleet level arguments (i.e. \texttt{fleets.ctrl[[fleet.name]]}):
  \begin{description}
    \item[\texttt{effort.range}:] A matrix of dimension [nmt,2], where rows contain the (minimum and maximum) 
        effort values for each metier and \texttt{colnames(effort.range) = c('min','max')}.
  \end{description}



%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
\subsubsection{Price models}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	

  The following price model functions are currently available:
  
\paragraph{\texttt{fixedPrice}: Fixed price model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

The prices are given as input data and are unchanged within the simulation.
Only the function name, \texttt{fixedPrice},  must be specified in  \texttt{price.model} element in \texttt{fleets.ctrl}
object.

\begin{Sinput}
	fleets.ctrl[[fleet.name]][[stock.name]]\$price.model <- 'FixedPrice'
\end{Sinput}


\paragraph{\texttt{elasticPrice}: Elastic price model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

This function implements the price function used in ~\cite{Kraak2004}:

	\begin{equation}\label{eq:elasticPrice}
		P_{a,y,s,f} = P_{a,0,s,f} \cdot \left( \frac{L_{a,0,s,f}}{L_{a,y,s,f}}\right)^{e_{a,s,f}} 
	\end{equation}
	
\noindent It uses base price, $P_{a,0,s,f}$,
and  base landings, $L_{a,0,s,f}$ to calculate the new price $P_{a,y,s,f}$ using a elasticity parameter $e_{a,s,f}, (e\geq0)$. 
If the base landings are bigger than current landings the price is increased and decreased if the contrary occurs.
$a$, $y$, $s$ and $f$ correspond to the subscripts for age, year, season and fleet, respectively. 
For simplicity, the iteration subscripts have been omitted but all the elements in the equation are iteration dependent.
As prices could also depend on total landings instead of on fleet's landings, there is an option to use  
$L_{a,0,s}$ instead of $L_{a,0,s,f}$ in the formula above.

Although price is stored at metier and stock level in \texttt{FLFleetsExt}, this function assumes that 
price is common to all metiers within a fleet and it is calculated at fleet level. 

\subparagraph{The \texttt{fleets.ctrl} argument in \texttt{elasticPrice} function}
\quad\\	

When \texttt{elasticPrice} is used, 
the following arguments must be specified, at fleet and stock level (i.e. for \texttt{fleets.ctrl[[fleet.name]][[stock.name]]}):

\begin{description}
	\item[\texttt{price.model}:] \texttt{'elasticPrice'}.
	\item[\texttt{pd.Pa0}:] An array with dimension \texttt{[age = na, season = ns, iter = ni]} to store base price,
							$P_{a,0,s,f}$.
	\item[\texttt{pd.La0}:] An array with dimension \texttt{[age = na, season = ns, iter = ni]} to store base landings, 
							$L_{a,0,s,f}$.
	\item[\texttt{pd.els}:] An array with dimension \texttt{[age = na, season = ns, iter = ni]} to store price elasticity,
							 $e_{a,s,f}$.
	\item[\texttt{pd.total}:] Logical. If \texttt{TRUE} the price is calculated using total landings and if 
							\texttt{FALSE} the landings of the fleet in question are used to estimate the price.
\end{description}



%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
\subsubsection{Capital models}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	

  The following capital model functions are currently available:


\paragraph{\texttt{fixedCapital}: Fixed capital model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

The capacity and catchability are given as input data and are unchanged within the simulation.
Only the function name, \texttt{fixedCapital},  must be specified in  \texttt{capital.model} element of \texttt{fleets.ctrl}
object.

\begin{Sinput}
  fleets.ctrl[[fleet.name]]\$capital.model <- 'FixedCapital'
\end{Sinput}


\paragraph{\texttt{SCD}: Simple Capital Dynamics model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

In this simple function catchability is not updated, it is an input parameter, and only
capacity is updated depending on some economic indicators. The following variables and indicators are defined
at fleet and year level (fleet and year subscripts are omitted for simplicity):

\begin{description}
	\item[$FuC$:] Fuel Cost.
	\item[$CrC$:] Crew Cost.
	\item[$VaC$:] Variable Costs.
	\item[$FxC$:] Fixed Costs (repair, maintenance and other).
	\item[$CaC$:] Capital Costs (depreciation and interest payment).
	\item[$Rev$:] Revenue, given by the formula:
		$$Rev_f = \sum_m\sum_s\sum_a L_{m,s,a}\cdot P_{a,s}$$
    \noindent where $L$ is the total landings, $P$ the price and $m$, $s$, $a$ the subscripts for metier, season and age, respectively.
	\item[$BER$:] Break Even Revenue, the revenues that make profit equal to 0.
		$$BER = \frac{FxC+CaC}{1-\frac{FuC}{Rev} - \frac{CrC}{Rev-FuC} + \frac{FuC\cdot CrC}{Rev \cdot (Rev-FuC)} - \frac{VaC}{Rev}}$$
\end{description}

In principle the investment, $Inv$, is determined by:

	$$Inv_0 = \frac{Rev-BER}{Rev}$$

But not all the profits are dedicated to increase the fleet, thus:

	$$Inv = \eta \cdot \frac{Rev-BER}{Rev}$$
	
\noindent where $\eta$ is the proportion of the profits that is used to buy new vessels. Furthermore, investment in new vessels 
will only occur if the operational days of existing vessels is equal to maximum days. If this occurs,
the investment/disinvestment decision, $\Omega$, will follow the rule below:


\begin{equation}
	\Omega_y = 
	\begin{cases}
		Inv			       & \text{, if } (Inv_0 < 0 \text{ and } \eta\cdot |Inv_0| < \omega_1) \text{ } | 
		                     \text{ } (Inv_0 > 0 \text{ and } \eta\cdot |Inv_0| < \omega_2)\\
		-\omega_1*\kappa_{y-1} & \text{, if } Inv_0 < 0 \text{ and } \eta\cdot |Inv_0| > \omega_1\\
		\omega_2*\kappa_{y-1} & \text{, if } Inv_0 > 0 \text{ and } \eta\cdot |Inv_0| > \omega_2
	\end{cases}
\end{equation}

\noindent where $\omega_2$ stands for the limit on the increase of the fleet relative to the previous year and 
$\omega_1$ for the limit on the decrease of the fleet relative to the previous year.\\

%\textit{This equation should be adapted to consider an average of the indicators of the previous years instead of 
%just using the value in the year before.\\
%The equation is not yet implemented but will be in the short term.}. 



%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
\subsubsection{Covariates models}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	

The following covariates model functions are currently available:

\paragraph{\texttt{fixedCovar}: Fixed covariates model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

The covariates that follow this model are given as input data and are unchanged within the simulation.
Only the function name, \texttt{fixedCovar}, must be specified in \texttt{process.model} element of \texttt{covars.ctrl}
object.

\begin{Sinput}
  covars.ctrl[[covar.name]]\$process.model <- 'fixedCovar'
\end{Sinput}

\paragraph{\texttt{ssb.get}: model to get the SSB of one stock} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

This function is used for including the real Spawning Stock Biomass of one of the simulated stocks as a covariate when fitting the stock recruitment relationship of another stock.
In the \texttt{covars.ctrl} object the following elements need to be specified:
\begin{description}
	\item[\texttt{process.model}:] \texttt{'ssb.get'}.
	\item[\texttt{ssb.stock}:] Character string with the name of the stock for which you want to get the SSB.
	\item[\texttt{spwn.sson}:] Numeric argument with the spawning season of this stock. 
	\item[\texttt{sr.covar}:] Character string with the name of the stock for wich you want to include the influence 
	                          of stock \texttt{ssb.stock} in its stock recruitment relationship.
\end{description}


%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
\subsubsection{Observation models: catch and biological parameters}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------

The functions in this section are used to generate a \texttt{FLStock} object
from \texttt{FLBiol} and \texttt{FLFleetsExt} objects. The former is used to 
fill the slots relative to biology, (\texttt{stock.wt}, \texttt{mat} and \texttt{m} slots), and  the 
last to fill the slots relative to catch, landings and discards. 
Whereas \texttt{harvest, stock} and \texttt{stock.n} slots are left empty and
\texttt{harvest.spwn} and \texttt{m.spwn} are set equal to 0.    

\paragraph{\texttt{age2ageDat}} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------
	This function creates an age structured \texttt{FLStock} from age structured 
	\texttt{FLBiol} and \texttt{FLFleetsExt} objects. The  slots 
% 	\texttt{catch}, \texttt{catch.n}, \texttt{catch.wt}, 
%   \texttt{discards}, \texttt{discards.n}, \texttt{discards.wt},
%   \texttt{landings}, \texttt{landings.n}, \texttt{landings.wt}, 
%   \texttt{m}, \texttt{mat}, 
of the \texttt{FLStock} object are filled in the following way:
	
\begin{description}
	
	\item[\texttt{landings.n}:] Observed landings at age are obtained from \texttt{fleets} object, summing them up along seasons, units, metiers and fleets. After summing up, two sources of uncertainty are introduced, one related to aging error and the second one related to misreporting. 
	Aging error is specified through \texttt{ages.error} argument, an array with dimension \texttt{[age = na, age = na, year = ny, iter = ni]}. For each year and iteration, each element \texttt{(i,j)} in the first 2 dimensions indicates the proportion of individuals of age \texttt{i} that are wrongly assigned to age \texttt{j}, thus the sum of the elements along the first dimension must be equal to 1. For each year and iteration, the real landings at age are multiplied matricially with the corresponding sub-matrix of \texttt{ages.error} object. 
	Afterwards, the second source of uncertainty is introduced multiplying the obtained landings at age by \texttt{land.nage.error}, an \texttt{FLQuant} with dimension \texttt{[age = na, year = ny, unit = 1, season = 1, area = 1, iter = ni]}.
	Once uncertainty is introduced in landings at age and weight at age, the total landings are computed and compared with the TAC. If  landings are lower than $\texttt{TAC}\cdot\texttt{TAC.ovrsht}$, the observed landings at age are unchanged, but if they were higher, the landings at age would be reduced by $\frac{1}{\texttt{TAC.ovrsht}}$ where \texttt{TAC.ovrsht} is a positive real number.
	
	\item[\texttt{landings.wt}:] Observed landings weight at age is derived from \texttt{fleets} object, averaging it along seasons, units, metiers and fleets. After averaging, 2 sources of uncertainty are introduced, one related to aging error and the second one related to misreporting. Aging error is the same as the one used in the landings at age. For each year and iteration, the real weight at age is weighted by the proportion of landings in each age group and multiplied matricially with the corresponding sub-matrix of \texttt{ages.error} object. 
	Afterwards, the second source of uncertainty is introduced multiplying the obtained weight at age by \texttt{land.wgt.error} an \texttt{FLQuant} with dimension \texttt{[age = na, year = ny, unit = 1, season = 1, area = 1, iter = ni]}.
	
	\item[\texttt{discards.n}:] Observed discards at age are obtained in the same way as the landings but summing up the discards instead of landings and using, in the second source of error, the object \texttt{disc.nage.error}, an \texttt{FLQuant} with dimension \texttt{[age = na, year = ny, unit = 1, season = 1, area = 1, iter = ni]}.
	The object \texttt{ages.error} is the same as the one used in the derivation of landings at age.
	
	\item[\texttt{discards.wt}:] Observed discards weight at age is obtained in the same way as the landings but averaging along discards weight instead of landings weight and using, in the second source of error, the object \texttt{disc.wgt.error}, an \texttt{FLQuant} with dimension \texttt{[age = na, year = ny, unit = 1, season = 1, area = 1, iter = ni]}.
	The object \texttt{ages.error} is the same as the one used in the derivation of landings at age. 
	
	\item[\texttt{discards, landings}:] Observed total discards and landings are derived from observed landings and discards at age and their corresponding weight.
	
	\item[\texttt{catch, catch.n, catch.wt}:] Slots related to observed catches are derived from the observed landings and discards at age and their corresponding weight.
		
	\item[\texttt{m}:] Observed natural mortality at age is obtained from \texttt{m} slot in \texttt{FLBiol}. Adittionally 2 sources of uncertainty are introduced.
	Firstly, for each year and iteration, this mortality is matriciallly multiplied by the ageing error (the same as the one used for catch related slots).
	Afterwards, the object is multiplied by \texttt{nmort.error}, where \texttt{nmort.error} is an \texttt{FLQuant} with dimension \texttt{[age = na, year = ny, unit = 1, season = 1, area = 1, iter = ni]}. 
	\texttt{nmort.error} is used to introduce multiplicative uncertainty in the observation of natural mortality. 
	
	\item[\texttt{mat}:] Observed proportion of individuals mature at age is obtained from \texttt{mat} slot in \texttt{FLBiol} object.
	Firstly, for each year and iteration, this proportion is matriciallly multiplied by the ageing error (the same as the one used for catch related slots).
	Afterwards, the object is multiplied by \texttt{mat.error}, where \texttt{mat.error} is an \texttt{FLQuant} with dimension \texttt{[age = na, year = ny, unit = 1, season = 1, area = 1, iter = ni]}.
	\texttt{mat.error} is used to introduce multiplicative uncertainty in the observation of maturity.

\end{description}


\paragraph{\texttt{bio2bioDat}} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------
	 This function creates a \texttt{FLStock} object aggregated in biomass from \texttt{FLBiol} and \texttt{FLFleetsExt} objects aggregated in biomass. 
		
\begin{description}
	\item[\texttt{m, mat, landings.n, landings.wt, discards.n, discards.wt, catch.n, catch.wt}] : Observed values for these slots are set to \texttt{NA}.
	\item[\texttt{discards}:] Observed discards are obtained as follows: the discards are summed up along fleets and metiers and then uncertainty	(observation error) is introduced using a multiplicative error. This multiplicative error is specified through \texttt{disc.bio.error} argument an \texttt{FLQuant} with dimension \texttt{[quant = 1, year = ny, unit = 1, season = 1, area = 1, iter = ni]}. 
	\item[\texttt{landings}:] Observed landings are derived in the same way as discards but the argument used to introduce uncertainty is called \texttt{land.bio.error} in this case. 
	  Once uncertainty is introduced in landings, they are compared with the TAC. If the landings are lower than $\texttt{TAC}\cdot\texttt{TAC.ovrsht}$, the observed landings are unchanged but if there were higher the landings would be reduced by $\frac{1}{\texttt{TAC.ovrsht}}$, where \texttt{TAC.ovrsht} is a positive real number.
	\item[\texttt{catch}:] Observed catch slot is equal to the sum of landings and discards.
\end{description}


\paragraph{\texttt{age2bioDat}} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------
	 This function creates a \texttt{FLStock} aggregated in biomass from
	 age structured \texttt{FLBiol} and \texttt{FLFleetsExt} objects. 
	 The function works exactly in the same way as \texttt{bio2bioDat} function.





%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
\subsubsection{Observation models: population}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------

These type of models are useful when no assessment model is used in the next step of the MPM and management
advice is just based on the population 'observed' in this step. \texttt{age2agePop}, \texttt{bio2bioPop}
and \texttt{age2bioPop} are equal to their relatives in the previous section but in this case
stock numbers, stock biomass and harvest are observed, with or without error, depending on the 
arguments given. 

\paragraph{\texttt{NoObsStock}} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function is used when the advice is given independently to stock status. Therefore, we do not need to observe the population.


\paragraph{\texttt{perfectObs}} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

	This function creates a \texttt{FLStock} from \texttt{FLBiol} and \texttt{FLFleetsExt} objects. 
	The \texttt{FLBiol} and \texttt{FLFleetsExt} objects can be either aggregated in biomass or age structured
	and the returned \texttt{FLStock} object will have the same structure, but with unit and season dimensions collapsed.  
	This function does not introduce any observation uncertainty in the observation of the different 
	quantities stored in the \texttt{FLStock} or \texttt{FLFLeetsExt} objects. Slots relative to biological parameters are calculated
	averaging across units and seasons, those relative to catch are calculated summing up across units and seasons, and numbers at
	age or biomass are taken from the start of the first season, except recruitment that is obtained summing up 
	the recruitment produced along seasons. Finally, fishing mortality is calculated numerically from numbers at age and 
	natural mortality. 


\paragraph{\texttt{age2agePop}} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

	This function operates exactly in the same way as its counterpart in the previous section, \texttt{age2ageDat},
	but it also fills \texttt{stock.n}, \texttt{stock.wt}, \texttt{stock} and  \texttt{harvest} slots:

	\begin{description}
		\item[\texttt{stock.n}:] First, the numbers at age are calculated as in \texttt{perfectObs} function and then 2 sources 
			of uncertainty are introduced, as it is done in landings and discards at age. The error attributed to aging error
			is given by the same argument as in landings and discards at age, \texttt{ages.error}. The second uncertainty 
			is introduced in the same way but by different argument, \texttt{stk.nage.error}.
		\item[\texttt{stock.wt}:] First, the weight at age is calculated as in \texttt{perfectObs} function and then 2 sources 
			of uncertainty are introduced, as it is done in weight at age of landings but replacing landings by stock numbers at age. 
			The error attributed to aging error is given by the same arguments as in landings, \texttt{ages.error}. The second uncertainty 
			is introduced in the same way but by different argument, \texttt{stk.wgt.error}.
		\item[\texttt{stock}:] This is equal to the sum of the product of \texttt{stock.n} and \texttt{stock.wt}.
		\item[\texttt{harvest}:] Harvest is numerically calculated from stock numbers at age and natural mortality. 
	\end{description}


\paragraph{\texttt{bio2bioPop}} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

	This function operates exactly in the same way as its counterpart in the previous section \texttt{bio2bioDat}
	but it also fills \texttt{stock} and  \texttt{harvest} slots:

	\begin{description}
		\item[\texttt{stock}:] Stock biomass is calculated multiplying \texttt{n} and \texttt{wt} slots in the \texttt{FLBiol}
			object and summing up along seasons (note that unit dimension is always equal to 1 in populations aggregated in biomass).
			After, that uncertainty in the observation is introduced multiplying the obtained biomass by the argument 
			\texttt{stk.bio.error}, which is an \texttt{FLQuant} with dimension 
			\texttt{[quant = 1, year = ny, unit = 1, season = 1, area = 1, iter = ni]}
		\item[\texttt{harvest}:] Harvest is calculated as the ratio between catch and stock biomass.
	\end{description}


\paragraph{\texttt{age2bioPop}} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

	This function operates exactly in the same way as its counterpart in the previous section \texttt{age2bioDat}, 
	but it also fills \texttt{stock} and  \texttt{harvest} slots. These two slots are calculated as in 
	\texttt{bio2bioPop} function but summing up along ages in the case of \texttt{stock} slot.


%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
\subsubsection{Observation models: abundance indices}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------

	Currently, there are 2 functions that simulate abundance indices, one that generates age structured abundance indices 
	\texttt{ageInd} and a second one that generates abundance indices in biomass \texttt{bioInd}. The last one can 
	be applied to both age structured and biomass dynamics populations. In both cases a linear relationship between 
	the index and the abundance is assumed being the catchability $q$ the slope, i.e:

		$$ I = q\cdot N \quad \text{ or } \quad I =q\cdot B$$ 
	
	\paragraph{\texttt{ageInd}: age index observation model} \hspace{0pt} \smallskip
  %----------------------------------------------------------------------------------------------------

	Age structured abundance indices are obtained multiplying 
	the slot \texttt{n} of \texttt{FLBiol} with the catchability of the 
	index (\texttt{catch.q} in \texttt{FLIndex} object). The \texttt{FLIndex} is an input 
	object and the \texttt{index} slot is yearly updated. Two sources of uncertainty are introduced, one
	related to aging error and a second one related to random variation. Aging error is the
	same as in the observation of landings at age and the argument is the same \texttt{ages.error}. 
	Afterwards, the second source of uncertainty is introduced multiplying the index by the slot
	\texttt{index.var} of the \texttt{FLIndex} object. The indices do not need to cover the full age or year ranges.

	\paragraph{\texttt{bioInd}: biomass index observation model} \hspace{0pt} \smallskip
  %----------------------------------------------------------------------------------------------------

	Biomass abundance indices are generated in the same way as age structured indices but without
	the error associated to age.
  
  \paragraph{\texttt{NoObsIndex}: no index observation} \hspace{0pt} \smallskip
  %----------------------------------------------------------------------------------------------------

  This function is used when abundance indices are not required.


%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
\subsubsection{Observation models: fleets} 
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
	At this point there are no functions to observe the fleets, their catch or catch at age is 
	just observed in an aggregated way in the functions defined in previous section. 
  %In the short term it is not planned to write such a function. This function would be useful to be able 
  %to test Fcube \citep{Ulrich2011} like approaches in management advice module.


%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	
\subsubsection{Management advice models}
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%----------------------------------------------------------------------------------------------------	

Different management advice models have been implemented. Some of them are methods generally applicable 
(e.g. \texttt{fixedAdvice}, \texttt{annualTAC}, \texttt{IcesHCR}, \texttt{annexIVHCR}, \texttt{CFPMSYHCR}, \texttt{F2CatchHCR}, \texttt{MAPHRC} and \texttt{MultiStockHRC}), 
whereas others are designed specifically for particular case studies (e.g. \texttt{FroeseHCR}, \texttt{ghlHCR}, \texttt{aneHCRE}, \texttt{neaMAC\_ltmp}, \texttt{little2011HCR}, \texttt{pidHCR} and \texttt{pidHCRtarg}). All these rules are single-stock, apart from \texttt{MAPHRC} and \texttt{MultiStockHRC}, which are multi-stock harvest control rules.

\paragraph{\texttt{fixedAdvice}: fixed advice model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function is used when the advice is fixed and independent to the stock status. 
  TAC or TAE values should be given as input in the \texttt{advice} object.

\paragraph{\texttt{annualTAC}: annual TAC model} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

	This function mimics the typical harvest control rule (HCR) used in recovery and management plans implemented in Europe.
	The function is a wrapper of the \texttt{fwd} function in \texttt{FLash} library.
	As \texttt{fwd} is only defined for age structured populations, within \texttt{FLBEIA} a new
	function \texttt{fwdBD} has been coded. \texttt{fwdBD} is a tracing of \texttt{fwd} but adapted to work with 
	populations aggregated in biomass. The advice is produced in terms of catch (i.e TAC). 
	
	The call to \texttt{annualTAC} function within \texttt{FLBEIA} is done as:
	
	\begin{center}
		\texttt{annualTAC(stocks, advice, advice.ctrl, year, stknm, ...)} 
	\end{center}

	If the management is being running in year \texttt{y}, the function works as follows:
	\begin{enumerate}
		\item Project the observed stock one year forward from 1st of January of year $y$ up 
			to 1st of January of year \texttt{y+1} (intermediate year).
		\item Apply the HCR and get the TAC for year \texttt{y+1}. Depending on the definition of the HCR the stock could be 
			projected several years forward. 
	\end{enumerate}


\subparagraph{\texttt{advice.ctrl[[stock.name]]} for \texttt{annualTAC}}

	\begin{description}
		\item[\texttt{HCR.model}:] \texttt{'annualTAC'}.
		\item[\texttt{nyears}:] Number of years to project the observed stock from year \texttt{y-1}.
		\item[\texttt{wts.nyears}:] Number of historic years to be used in the average of biological parameters. 
			The average is used in the projection of biological parameters.
		\item[\texttt{fbar.nyears}:] Number of historic years to be used in the average of selection pattern. 
			The average is used in the projection of selection pattern.
		\item[\texttt{f.rescale}:] Logical.  If \texttt{TRUE} rescale to status quo fishing mortality.
		\item[\texttt{disc.nyears}:] Number of years over which to calculate mean for
          	\texttt{discards.n} and \texttt{landings.n } slots. 
		\item[\texttt{fwd.ctrl}:] Element of class \texttt{fwdControl}. For details on this look at the help page in \texttt{FLash}
			object. The only difference is the way the years are introduced. As this object is defined before simulation 
			and it is applied year by year, the definition of the year should be dynamic. Thus the following convention
			has been taken:
				\begin{itemize}
					\item \texttt{year = 0} indicates the year when management is taking place, (intermediate year).
					\item \texttt{year = -1} corresponds with one year before the year when management is taking place. 
						In this case, whithin \texttt{annualTAC} function, coincides with the year up to which data is available, (data year). 
						Then,  -2 would indicate 2 years before,-3 would indicate 3 years before and so on. 
					\item \texttt{year = 1} corresponds with one year after the year when management is taking place.  
						In this case, whithin \texttt{annualTAC} function, coincides with the year for which management 
						advice is going to be produced, (TAC year).
						Then,  2 would indicate 2 years after the year when management is taken place, 
						3 would indicate 3 years after and so on. 
				\end{itemize}
			In this way, within the simulation, each year, the intermediate year is summed up to the \texttt{year} in the original control
			argument and the correct year names are obtained. 
		\item[\texttt{AdvCatch}:] Vector with a logic value for each year. TAC is given in terms of catch, if \texttt{TRUE}, or landings, if \texttt{FALSE}.
		\item[\texttt{sr}:] The stock recruitment relationship used to project the observed stock forward, not needed in the
			case of population aggregated in biomass. \texttt{sr} is a list with 3 elements, \texttt{model, params} and
			\texttt{years}. \texttt{model} is mandatory and the other 2 are complementary, if \texttt{params} is given
			\texttt{years} is not necessary. \texttt{model} can be any stock-recruitment model defined for \texttt{FLSR} 
			class. \texttt{params} is a \texttt{FLPar} model an if specified it is used to parameterized the 
			stock-recruitment model.  \texttt{years} is a numeric named vector with 2 elements \texttt{'y.rm'} and 
			\texttt{'num.years'}, for example \texttt{c(y.rm = 2, num.years = 10)}. This element is used to 
			determine the observeds years to be used to estimate the parameters of the stock recruitment relationship. 
			In the example the last 2 observations will be removed and starting from the year before to the last 2 observed years 
			10 years will be used to estimate the stock-recruitment parameters.
			%\texttt{'y.rm'} indicates the
		\item[\texttt{growth.years}:] This argument is used only for stocks aggregated in biomass and it indicates the years
			to be used in the estimation of annual population growth. This growth is used to project the population forward. 
			\texttt{growth.years} is a numeric named vector with 2 elements \texttt{'y.rm'} and 
			\texttt{'num.years'} which play the same role played in \texttt{sr[['years']]} argument defined in the 
			previous point.
	\end{description}

\paragraph{\texttt{IcesHCR}: ICES harvest control rule} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  The function represents the HCR used by ICES to generate TAC advice in the MSY framework. It is a biomass based HCR, where the TAC advice depends on F in relation to several reference points: a biomass that triggers the F reduction (\texttt{B$_{trigger}$}), the limit biomass below which there is a high risk of impaired recruitment (\texttt{B$_{lim}$}) and fishing mortality that leads to MSY (\texttt{F$_{MSY}$}).
  
  Current function calls \texttt{annualTAC}, given an F objective calculated as:

  \begin{equation}
  	F_{target} = 
  	\begin{cases}
				0                       & \text{, if } B < B_{lim}\\
				F_{MSY} \cdot B/B_{trigger} & \text{, if } B < B_{trigger}\\
				F_{MSY}                 & \text{, if } B \geq B_{trigger}
  	\end{cases}
  \end{equation}

  The call to \texttt{IcesHCR} function within \texttt{FLBEIA} is done as:
	\begin{center}
		\texttt{IcesHCR(stocks, advice, advice.ctrl, year, stknm, ...)}
	\end{center}
	
	\subparagraph{\texttt{advice.ctrl[[stock.name]]} for \texttt{IcesHCR}}

	  \begin{description}
	    \item[\texttt{HCR.model}:] \texttt{'IcesHCR'}.
	    \item[\texttt{nyears}:] Number of years to project the observed stock from year \texttt{y-1}.
		  \item[\texttt{wts.nyears}:] Number of historic years to be used in the average of biological parameters, if missing last 3 years are used. The average is used in the projection of biological parameters.
		  \item[\texttt{fbar.nyears}:] Number of historic years to be used in the average of selection pattern, if missing last 3 years are used. The average is used in the projection of selection pattern.
		  \item[\texttt{f.rescale}:] Logical.  If \texttt{TRUE} rescale to status quo fishing mortality.
		  \item[\texttt{ref.pts}:] Matrix of dimension [3,it], 
		    where rows contain values for $B_{lim}$, $B_{trigger}$ and $F_{MSY}$,
		    and \texttt{colnames(ref.pts) = c(Blim, Btrigger, Fmsy)}.
		  \item[\texttt{AdvCatch}:] Vector with a logic value for each year. TAC is given in terms of catch, if \texttt{TRUE}, or landings, if \texttt{FALSE}.
		  \item[\texttt{intermediate.year}:] Sets how to calculate the catches in the intermediate year. 
		    If it is set to \texttt{'Fsq'}, then the catches are estimated based on the last estimated F; 
		    whereas if other value set, the catches are set to the TAC adviced for this intermediate year. 
		    This second approach is used for the cases when the assessment is carried out including also the 
		    information on this intermediate year, as is the case for the Bay of Biscay anchovy.
		  \item[\texttt{sr}:] The stock recruitment relationship used to project the observed stock forward, not needed in the case of population aggregated in biomass. \texttt{sr} is a list with 3 elements, \texttt{model, params} and \texttt{years}. For more details see parameter description in \texttt{annualTAC} (above).
		  \item[\texttt{growth.years}:] This argument is used only for stocks aggregated in biomass and it indicates the years
			to be used in the estimation of annual population growth. This growth is used to project the population forward. 
			For more details see parameter description in \texttt{annualTAC} (above).
	\end{description}


\paragraph{\texttt{FroeseHCR}: Froese harvest control rule} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

   This function recreates the HCR defined in the paper by \cite{Froese2011}, which is a biomass based HCR.
   TAC advice is calculated depending on perceived biomass in relation to biological reference points as follows:

  \begin{equation}
  	TAC = 
  	\begin{cases}
				0                & \text{, if } B < B_{trigger}\\
				MSY \cdot \beta \cdot 1/(1-\alpha_0)*(-\alpha_0 + B / B_{target}) & \text{, if } B_{trigger} \leq B < B_{target}\\
				MSY \cdot \beta  & \text{, if } B \leq B_{target}
  	\end{cases}
  \end{equation}
  \noindent where $B_{trigger} = \alpha_0 \cdot B_{MSY}$ and $B_{target} = \alpha_1 \cdot B_{MSY}$.

   The call to \texttt{annualTAC} function within \texttt{FLBEIA} is done as:
	
	\begin{center}
		\texttt{FroeseHCR(stocks, advice, advice.ctrl, year, stknm,...)} 
	\end{center}
	
	\subparagraph{\texttt{advice.ctrl[[stock.name]]} for \texttt{FroeseHCR}}

	  \begin{description}
	    \item[\texttt{HCR.model}:] \texttt{'FroeseHCR'}.
		  \item[\texttt{ref.pts}:] Matrix of dimension [5,it], 
		    where rows contain values for $B_{MSY}$, $MSY$, $\alpha_0$, $\alpha_1$ and $\beta$, 
		    and \texttt{colnames(ref.pts) = c(Bmsy, MSY, alpha\_0, alpha\_1, beta)}.
	\end{description}


\paragraph{\texttt{annexIVHCR}: ICES Annex IV harvest control rule} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function emulates the HCR used by the European Commission and ICES to generate the TAC advice for data poor stocks.
  TAC advice is calculated depending on previous year TAC and the trend of an available index as follows:

  \begin{equation}
  	TAC_{y+1} =  \gamma \cdot TAC_y \\
  \end{equation}

  \begin{equation}
  	\gamma =
  	\begin{cases}
				1 - \beta & \text{, if } B_{now}/B_{ref} \leq 1 - \alpha \\
				1         & \text{, if } 1 - \alpha < B_{now}/B_{ref} < 1 + \alpha
				            \text{ \& }  type = 2\\
				\beta/\alpha \cdot (B_{now}/B_{ref}-1) + 1
				          & \text{, if } 1 - \alpha < B_{now}/B_{ref} < 1 + \alpha
				            \text{ \& }  type = 4\\
				1 + \beta & \text{, if } B_{now}/B_{ref} \geq 1 + \alpha
  	\end{cases}
  	\label{eq:annexIVHCR_gamma}
  \end{equation}
  \noindent where: $B_{now} = (I_{y-1} + I_{y-2}) / 2$ and  $B_{ref} = (I_{y-3} + I_{y-4} + I_{y-5}) / 3$.

  The call to \texttt{annexIVHCR} function within \texttt{FLBEIA} is done as:
	
	\begin{center}
		\texttt{annexIVHCR(indices, advice, advice.ctrl, year, stknm,...)} 
	\end{center}

	\subparagraph{\texttt{advice.ctrl[[stock.name]]} for \texttt{annexIVHCR}}

	\begin{description}
	    \item[\texttt{HCR.model}:] \texttt{'annexIVHCR'}.
		  \item[\texttt{index}:] Either the name or the position of the index in FLIndices object.
		  \item[\texttt{ref.pts}:] Matrix of dimension [2,it], 
		    where rows contain values for $\alpha$ and $\beta$, 
		    and \texttt{colnames(ref.pts) = c(alpha, beta)}.
		  \item[\texttt{type}:] Numeric (options 2 or 4). This parameter determinines the value of $\gamma$ in Equation~\ref{eq:annexIVHCR_gamma}.
	\end{description}


\paragraph{\texttt{ghlHCR}: Greenland halibut harvest control rule} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function mimics thee model-free HCR used in the management of greenland-halibut in NAFO.
  TAC advice is calculated depending on previous year TAC and the trends of three indices available for the stock as follows:

  \begin{equation}
  	TAC_{y+1} =  TAC_y + \lambda \cdot slope \\
  \end{equation}

  \begin{equation}
  	\lambda =
  	\begin{cases}
				\alpha_0 & \text{, if } slope < 0 \\
				\alpha_1 & \text{, if } slope > 0
  	\end{cases}
  \end{equation}
  \noindent where $\lambda$ value has the following additional constraint: $1 - \beta \leq \lambda \leq 1 + \beta$, and 
  $slope$ is the mean of the slopes obtained when calculating a linear model for each of the indices.

  The call to \texttt{ghlHCR} function within \texttt{FLBEIA} is done as:

	\begin{center}
		\texttt{ghlHCRC(indices, advice, advice.ctrl, year, stknm,...)}
	\end{center}

	\subparagraph{\texttt{advice.ctrl[[stock.name]]} for \texttt{ghlHCR}}

	\begin{description}
	    \item[\texttt{HCR.model}:] \texttt{'ghlHCR'}.
		  \item[\texttt{ref.pts}:] Matrix of dimension [3,it], 
		    where rows contain values for $\alpha_0$, $\alpha_1$ and $\beta$,
		    and \texttt{colnames(ref.pts) = c(alpha\_0, alpha\_1, beta)}.
		    
	\end{description}


\paragraph{\texttt{aneHCRE}: Bay of Biscay anchovy first long term management plan - HCRE} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  The function recreates the HCR used in the Bay of Biscay anchovy first long term management plan, where HCR was known as Rule E.
  
  
  TAC advice is calculated depending on perceived biomass in relation to biological reference points as follows:

  \begin{equation}
  	TAC =
  	\begin{cases}
				0             & \text{, if } SSB \leq 24,000 \text{tons} \\
				7,000         & \text{, if } 24,000 < SSB < 33,000 \text{tons}\\
				hr  \cdot SSB & \text{, if } SSB \geq 33,000 \text{tons}
  	\end{cases}
  \end{equation}
  \noindent whith the following additional constraint: $TAC \leq 33,000$ \text{tons}.


  The call to \texttt{aneHCRE} function within \texttt{FLBEIA} is done as:

	\begin{center}
		\texttt{aneHCRE(stocks, advice, advice.ctrl, year, stknm,...)}
	\end{center}


\paragraph{\texttt{neaMAC\_ltmp}: Northeast Atlantic mackerel long term management plan} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function emulates the HCR used in the north-east atlantic mackerel long term management plan. 
  It is a particular case of the IcesHCR.
  
  
  \paragraph{\texttt{F2CatchHCR}: F to catch harvest control rule} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function transforms the fishing mortality advice given as input data to catch advice without any other restriction.
  The function is a copy-paste from \texttt{IcesHCR}, but in this case target F is directly taken from \texttt{ref.pts['Ftarget',year+1,]}.
  

  \paragraph{\texttt{little2011HCR}: Little's harvest control rules} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function mimics the HCR defined in the paper by \cite{Littel2011}, with an additional constraint, $C_{max}$, not to allow very high catches. This constraint can be turned off setting $C_{max}$ to a very high value or \texttt{Inf}.
  
  
  
  TAC advice is calculated depending on an index in relation to biologicalsome reference points as follows:

  \begin{equation}
  	TAC = min( C_{targ} \cdot max(0,(I_{y}-I_{lim})/(I_{targ}-I_{lim})), C_{max})
  \end{equation}

  \noindent where: $C_{targ}$ and $C_{max}$ correspond to target and maximum catches, respectively, 
  $I_{y}$ corresponds to the mean value of the index in the last two years and $I_{targ}$, $I_{lim})$ are reference values with respect to the index.


  The call to \texttt{little2011HCR} function within \texttt{FLBEIA} is done as:

	\begin{center}
		\texttt{little2011HCR(indices, advice, advice.ctrl, year, stknm, ...)}
	\end{center}

	\subparagraph{\texttt{advice.ctrl[[stock.name]]} for \texttt{little2011HCR}}

	\begin{description}
	    \item[\texttt{HCR.model}:] \texttt{'little2011HCR'}.
	    \item[\texttt{index}:] Either the name or the position of the index in FLIndices object.
		  \item[\texttt{ref.pts}:] Matrix of dimension [4,it], 
		    where rows contain values for $C_{targ}$, $I_{lim}$, $I_{targ}$  and $C_{max}$.
		    and \texttt{colnames(ref.pts) = c(Ctarg, Ilim, Itarg, Cmax)}.
	\end{description}
  

  \paragraph{\texttt{pidHCR and pidHCRtarg}: Pomaerede's harvest control rules} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  These functions recreates the model free HCRs used for hake and wich are defined in the paper by \cite{Pomarede2010}.
  
  % TAC advice is calculated depending on ??
  % Missing description as an equation.

  The call to these functions within \texttt{FLBEIA} is done as:

	\begin{center}
		\texttt{pidHCR(indices, advice, advice.ctrl, year, stknm, ...)} \\
		\texttt{pidHCRtarg(indices, advice, advice.ctrl, year, stknm, ...)}
	\end{center}

	\subparagraph{\texttt{advice.ctrl[[stock.name]]} for \texttt{pidHCR} and \texttt{pidHCRtarg}}

	\begin{description}
	    \item[\texttt{HCR.model}:] \texttt{'pidHCR'} or \texttt{'pidHCRtarg'}.
	    \item[\texttt{index}:] Either the name or the position of the index in FLIndices object.
		  \item[\texttt{ref.pts}:] For \texttt{pidHCR}, matrix of dimension [5,it], 
		    where rows contain values for $K_p$, $K_i$, $K_d$, $\tau$ and $\alpha$; 
		    whereas for function \texttt{pidHCRtarg} it has dimension [6,it] with an additional row for $I_{targ}$ values.
		    \texttt{colnames(ref.pts) = c(Kp, Ki, Kd, tau, alpha, Itarg)}.
	\end{description}


  \paragraph{\texttt{MAPHRC}: harvest control rule for multi-annual management plans} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function emulates the HCR proposed by the European Commission for the evaluation of multi-annual management plans (MAPs) in 2015. 
  This HCR is specially designed to fulfill the requirements of MAPs for North Western Waters and only works for age-structured stocks.

%   Missing description as an equation.  
  
  The call to \texttt{MAPHRC} function within \texttt{FLBEIA} is done as:

	\begin{center}
		\texttt{MAPHRC(stocks, advice, advice.ctrl, year, stknm, ...)}
	\end{center}

	\subparagraph{\texttt{advice.ctrl[[stock.name]]} for \texttt{MAPHRC}}

	  \begin{description}
	    \item[\texttt{HCR.model}:] \texttt{'MAPHRC'}.
	    % \item[\texttt{nyears}:] Number of years to project the observed stock from year \texttt{y-1}.
		  \item[\texttt{wts.nyears}:] Number of historic years to be used in the average of biological parameters, if missing last 3 years are used. The average is used in the projection of biological parameters.
		  \item[\texttt{fbar.nyears}:] Number of historic years to be used in the average of selection pattern, if missing last 3 years are used. The average is used in the projection of selection pattern.
		  \item[\texttt{f.rescale}:] Logical.  If \texttt{TRUE} rescale to status quo fishing mortality.
		  \item[\texttt{ref.pts}:] FLQuant of dimension \texttt{[quant = 4, year = ny, unit = 1, season = 1, area = 1, iter = ni]}, 
		    where \texttt{quant} dimension contains values for $B_{pa}$, $F_{target}$, $C_{up}$ and $C_{lo}$, 
		    and \texttt{dimnames(ref.pts)[1] = c(Bpa, Ftarget, Cup, Clo)}.
		  \item[\texttt{N}:]  Numeric value, corresponding to the number of years to recover SSB.
		  \item[\texttt{AdvCatch}:] Vector with a logic value for each year. TAC is given in terms of catch, if \texttt{TRUE}, or landings, if \texttt{FALSE}.
		  \item[\texttt{sr}:] The stock recruitment relationship used to project the observed stock forward, not needed in the case of population aggregated in biomass. \texttt{sr} is a list with 3 elements, \texttt{model, params} and \texttt{years}. For more details see parameter description in \texttt{annualTAC} (above).
	\end{description}


  \paragraph{\texttt{CFPMSYHCR}: flexible harvest control rule for multi-annual management plans} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function is a version of the \texttt{MAPHCR}, adapting it to allow flexibility in the year Fmsy is achieved. 
  The user can specify the year in which you aim to reach $F_{MSY}$, with a linear transition between $F_{sq}$ to $F_{MSY}$ in the intervening years.

  The call to \texttt{CFPMSYHCR} function within \texttt{FLBEIA} is done as:

	\begin{center}
		\texttt{CFPMSYHCR(stocks, advice, advice.ctrl, year, stknm, ...)}
	\end{center}

	\subparagraph{\texttt{advice.ctrl[[stock.name]]} for \texttt{CFPMSYHCR}}

	  \begin{description}
	    \item[\texttt{HCR.model}:] \texttt{'CFPMSYHCR'}.
	    % \item[\texttt{nyears}:] Number of years to project the observed stock from year \texttt{y-1}.
		  \item[\texttt{wts.nyears}:] Number of historic years to be used in the average of biological parameters, if missing last 3 years are used. The average is used in the projection of biological parameters.
		  \item[\texttt{fbar.nyears}:] Number of historic years to be used in the average of selection pattern, if missing last 3 years are used. The average is used in the projection of selection pattern.
		  \item[\texttt{f.rescale}:] Logical.  If \texttt{TRUE} rescale to status quo fishing mortality.
		  \item[\texttt{ref.pts}:] FLQuant of dimension \texttt{[quant = 5, year = ny, unit = 1, season = 1, area = 1, iter = ni]}, 
		    where \texttt{quant} dimension contains values for $B_{pa}$, $F_{target}$, $Yr_{tg}$, $C_{up}$ and $C_{lo}$, 
		    and \texttt{dimnames(ref.pts)[1] = c(Bpa, Ftarget, Yrtg, Cup, Clo)}.
		    
		  \item[\texttt{N}:]  Numeric value, corresponding to the number of years to recover SSB.
		  \item[\texttt{AdvCatch}:] Vector with a logic value for each year. TAC is given in terms of catch, if \texttt{TRUE}, or landings, if \texttt{FALSE}.
		  \item[\texttt{sr}:] The stock recruitment relationship used to project the observed stock forward, not needed in the case of population aggregated in biomass. \texttt{sr} is a list with 3 elements, \texttt{model, params} and \texttt{years}. For more details see parameter description in \texttt{annualTAC} (above).
	\end{description}  
  


  \paragraph{\texttt{MultiStockHRC}: multi-stock harvest control rule} \hspace{0pt} \smallskip
%----------------------------------------------------------------------------------------------------

  This function produces TAC advice for several stocks simultaneously, this HCR is based on \texttt{IcesHCR}. 
  It uses a fishing mortality target and an upper bound to conciliate the TAC advices. In the case of stocks without exploitation rate estimates, then it uses the catch. At present this function only works with single iterations.
  
  
  TAC advice is calculated depending on fishing mortality in relation to biological reference points of all the stocks.
  First, for each stock we calculate the single stock  Ftarget depending on its status in relation to the BRPs.
    \begin{equation}
    	F_{target} =
    	\begin{cases}
  				0                              & \text{, if } B < B_{lim} \\
  				F_{MSY} \cdot  B / B_{trigger} & \text{, if } B_{lim} \leq B < B_{trigger} \\
  				F_{MSY}                        & \text{, if } B \geq B_{trigger}
    	\end{cases}
    \end{equation}
  Second, we calculate the ratio between $F_{target}$ and $F_{sq}$ and calculate the maximum:
    \begin{equation}
    	F_{adv0}[stock.name] = \lambda_0 \cdot F_{sq} | \lambda_0 = max_{i \in names(biols)}(F_{target}/F_{sq})[i]
    \end{equation}
  Therefore, there is only one stock for which $F_{adv0} = F_{target}$ and for the rest $F_{adv0} > F_{target}$.
  Third, we calculate the ratio between Fupp and Fsq and calculate the minimum:
    \begin{equation}
    	x_{st} = F_{upp}[stock.name] /  F_{adv0}[stock.name]\lambda_0 \cdot F_{sq} \forall st \in names(biols)
    \end{equation}
    \begin{equation}
       \begin{cases}
  			  \text{If } x_{st} \geq 1  \text{ } \forall st,
  			          & \lambda_1 = 1 \\
  			  \text{If } \exists st \text{ } \& \text{ }  x_{st} < 1,
  			          & \lambda_1 = min(\frac{F_{upp}[st]}{F_{adv0}[st]}) \\
  			          & \text{ } \& F_{adv1}[st] = \lambda_1 \cdot F_{adv0}[st]
    	\end{cases}
    \end{equation}
  Therefore, there is only one stock for which $F_{adv0} = F_{target}$ and for the rest $F_{adv0} > F_{target}$.
  Finally, 
    \begin{equation}
    	F_{adv}[stock.name] = \lambda_1 \cdot \lambda_0 \cdot F_{sq}
    \end{equation}
  And the TAC for each stock is calculated based on advised fishing mortality (i.e. $F_{adv}[stock.name]$).
  
  The call to \texttt{annualTAC} function within \texttt{FLBEIA} is done as:
	
	\begin{center}
		\texttt{MultiStockHCR(stocks, indices, advice, advice.ctrl, year, stknm,...)} 
	\end{center}
	
	  In relation to \texttt{IcesHCR} this new HCR has two additional arguments:
	\begin{description}
      \item[\texttt{advice.ctrl[['stocksInHCR']]}:] A vector with the name of the stocks that are taken into account in the calculation of advice.
		  \item[\texttt{advice.ctrl[[stock.name]][['ref.pts']]}:] A new row in the matrix with \texttt{Fupp} value.
	\end{description}

